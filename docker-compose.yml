services:
  nginx:
    image: nginx:1.27-alpine
    container_name: wikijs-nginx
    restart: unless-stopped
    depends_on:
      wiki:
        condition: service_started
    ports:
      - "80:80"
    volumes:
      - ./nginx/default.conf:/etc/nginx/conf.d/default.conf:ro

  wiki:
    image: ghcr.io/requarks/wiki:2
    container_name: wikijs
    restart: unless-stopped
    depends_on:
      postgres:
        condition: service_healthy
    environment:
      DB_TYPE: postgres
      DB_HOST: postgres
      DB_PORT: 5432
      DB_USER: wikijs
      DB_PASS: wikijsrocks
      DB_NAME: wiki
    volumes:
      - ./wiki/data:/wiki/data

  postgres:
    image: postgres:16-alpine
    container_name: wikijs-postgres
    restart: unless-stopped
    environment:
      POSTGRES_DB: wiki
      POSTGRES_USER: wikijs
      POSTGRES_PASSWORD: wikijsrocks
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5433:5432"
    volumes:
      - ./wiki/data/postgres:/var/lib/postgresql/data
      - ./wiki/data/postgres-init:/docker-entrypoint-initdb.d:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U wikijs -d wiki"]
      interval: 10s
      timeout: 5s
      retries: 10

  redis:
    image: redis:7-alpine
    container_name: wikijs-redis
    restart: unless-stopped
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - ./wiki/data/redis:/data

  redis-exporter:
    image: oliver006/redis_exporter:v1.67.0
    container_name: wikijs-redis-exporter
    restart: unless-stopped
    depends_on:
      redis:
        condition: service_started
    environment:
      REDIS_ADDR: redis://redis:6379

  prometheus:
    image: prom/prometheus:v2.54.1
    container_name: wikijs-prometheus
    restart: unless-stopped
    depends_on:
      redis-exporter:
        condition: service_started
    ports:
      - "9090:9090"
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus

  grafana:
    image: grafana/grafana:11.2.0
    container_name: wikijs-grafana
    restart: unless-stopped
    depends_on:
      prometheus:
        condition: service_started
    environment:
      GF_METRICS_ENABLED: "true"
    ports:
      - "3001:3000"
    volumes:
      - grafana_data:/var/lib/grafana

volumes:
  prometheus_data:
  grafana_data:
